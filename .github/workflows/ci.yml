name: CI/CD PYTHIA

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

# Cancel in-progress runs on new pushes to the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ─── Backend unit tests ────────────────────────────────────────────────────
  test-backend:
    name: Backend tests
    runs-on: self-hosted
    steps:
      - name: Clean root-owned files from previous runs
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            python:3.11-slim \
            sh -c "find /workspace/backend -type d \( -name __pycache__ -o -name .pytest_cache \) -exec rm -rf {} + 2>/dev/null; exit 0"

      - uses: actions/checkout@v4

      - name: Run tests
        run: |
          docker run --rm \
            --user $(id -u):$(id -g) \
            --env HOME=/tmp \
            -v ${{ github.workspace }}/backend:/app \
            -w /app \
            python:3.11-slim \
            sh -c "python -m venv /tmp/venv && /tmp/venv/bin/pip install -r requirements.txt pytest pytest-asyncio -q && /tmp/venv/bin/pytest tests/ -v --tb=short -p no:cacheprovider"

  # ─── Frontend unit tests ───────────────────────────────────────────────────
  test-frontend:
    name: Frontend tests
    runs-on: self-hosted
    steps:
      - name: Clean root-owned files from previous runs
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            python:3.11-slim \
            sh -c "find /workspace/backend -type d \( -name __pycache__ -o -name .pytest_cache \) -exec rm -rf {} + 2>/dev/null; exit 0"

      - uses: actions/checkout@v4

      - name: Run tests
        run: |
          docker run --rm \
            --user $(id -u):$(id -g) \
            --env HOME=/tmp \
            -v ${{ github.workspace }}/frontend:/app \
            -w /app \
            node:20-alpine \
            sh -c "npm ci && npm test -- --run"

  # ─── Deploy (main branch only, after tests pass) ──────────────────────────
  deploy:
    name: Deploy
    runs-on: self-hosted
    needs: [test-backend, test-frontend]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Load .env
        run: cp ~/.pythia.env .env

      - name: Stop existing containers
        run: |
          docker stop pythia-frontend pythia-backend 2>/dev/null || true
          docker rm pythia-frontend pythia-backend 2>/dev/null || true

      - name: Build and start containers
        run: |
          set -a && source .env && set +a
          docker compose up --build -d

      - name: Wait for backend health
        run: |
          set -a && source .env && set +a
          PORT="${BACKEND_PORT:-8082}"
          echo "Waiting for backend on port $PORT..."
          for i in $(seq 1 18); do
            if curl -sf "http://localhost:${PORT}/health" > /dev/null; then
              echo "Backend is healthy (attempt $i)"
              exit 0
            fi
            echo "  attempt $i/18, retrying in 10s..."
            sleep 10
          done
          echo "Backend did not become healthy within 3 minutes"
          docker compose logs pythia-backend
          exit 1

      - name: Smoke tests
        run: |
          set -a && source .env && set +a
          PORT="${BACKEND_PORT:-8082}"
          FPORT="${FRONTEND_PORT:-8081}"
          FAILED=0

          # /health → { "status": "ok" }
          curl -sf "http://localhost:${PORT}/health" | grep -q '"ok"' \
            && echo "PASS  /health" \
            || { echo "FAIL  /health"; FAILED=1; }

          # /api/events → JSON array
          curl -sf "http://localhost:${PORT}/api/events" | grep -q '^\[' \
            && echo "PASS  /api/events" \
            || { echo "FAIL  /api/events"; FAILED=1; }

          # Frontend HTML contains PYTHIA
          curl -sf "http://localhost:${FPORT}/" | grep -qi "pythia" \
            && echo "PASS  frontend" \
            || { echo "FAIL  frontend"; FAILED=1; }

          [ $FAILED -eq 0 ] || exit 1
          echo "All smoke tests passed"

      - name: Container status
        if: always()
        run: docker compose ps
