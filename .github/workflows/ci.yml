name: CI/CD PYTHIA

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

# Cancel in-progress runs on new pushes to the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ─── Backend unit tests ────────────────────────────────────────────────────
  test-backend:
    name: Backend tests
    runs-on: self-hosted
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4

      - name: Create virtual environment
        run: python3 -m venv .venv

      - name: Install dependencies
        run: |
          .venv/bin/pip install --upgrade pip --quiet
          .venv/bin/pip install -r requirements.txt --quiet
          .venv/bin/pip install pytest pytest-asyncio --quiet

      - name: Run tests
        run: .venv/bin/pytest tests/ -v --tb=short

      - name: Cleanup
        if: always()
        run: rm -rf .venv

  # ─── Frontend unit tests ───────────────────────────────────────────────────
  test-frontend:
    name: Frontend tests
    runs-on: self-hosted
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: npm ci --prefer-offline

      - name: Run tests
        run: npm test -- --run

  # ─── Deploy (main branch only, after tests pass) ──────────────────────────
  deploy:
    name: Deploy
    runs-on: self-hosted
    needs: [test-backend, test-frontend]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Load .env
        run: cp ~/.pythia.env .env

      - name: Build and start containers
        run: docker compose up --build -d

      - name: Wait for backend health
        run: |
          PORT="${BACKEND_PORT:-8000}"
          echo "Waiting for backend on port $PORT..."
          for i in $(seq 1 18); do
            if curl -sf "http://localhost:${PORT}/health" > /dev/null; then
              echo "Backend is healthy (attempt $i)"
              exit 0
            fi
            echo "  attempt $i/18, retrying in 10s..."
            sleep 10
          done
          echo "Backend did not become healthy within 3 minutes"
          docker compose logs pythia-backend
          exit 1

      - name: Smoke tests
        run: |
          PORT="${BACKEND_PORT:-8000}"
          FPORT="${FRONTEND_PORT:-80}"
          FAILED=0

          # /health → { "status": "ok" }
          STATUS=$(curl -sf "http://localhost:${PORT}/health" \
            | python3 -c "import sys, json; print(json.load(sys.stdin)['status'])")
          if [ "$STATUS" = "ok" ]; then
            echo "PASS  /health"
          else
            echo "FAIL  /health — got: $STATUS"
            FAILED=1
          fi

          # /api/events → JSON array
          curl -sf "http://localhost:${PORT}/api/events" | python3 -c "
          import sys, json
          d = json.load(sys.stdin)
          assert isinstance(d, list), f'Expected list, got {type(d).__name__}'
          print(f'PASS  /api/events ({len(d)} events in history)')
          " || { echo "FAIL  /api/events"; FAILED=1; }

          # Frontend HTML contains PYTHIA
          curl -sf "http://localhost:${FPORT}/" | grep -qi "pythia" \
            && echo "PASS  frontend" \
            || { echo "FAIL  frontend — no PYTHIA reference in HTML"; FAILED=1; }

          [ $FAILED -eq 0 ] || exit 1
          echo "All smoke tests passed"

      - name: Container status
        if: always()
        run: docker compose ps
